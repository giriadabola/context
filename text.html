<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Editor de Documentos Simplificado</title>
    <style>
        :root {
            color-scheme: dark light;
            --primary-bg: #1e1e1e;
            --secondary-bg: #252525;
            --tertiary-bg: #2d2d2d;
            --border-color: #3a3a3a;
            --text-color: #d4d4d4;
            --accent-color: #3a7ca5;
            --accent-color-hover: #4a90c2;
            --selected-bg: #3a7ca5;
        }
        body {
            font-family: sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--primary-bg);
            color: var(--text-color);
        }
        .container {
            max-width: 900px;
            margin: auto;
            background: var(--tertiary-bg);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0,0,0,0.5);
            position: relative;
        }
        #initialScreen { text-align: center; padding: 40px 20px; }
        #initialScreen h1 { margin-bottom: 30px; color: #e0e0e0; }
        .initial-actions button {
            padding: 12px 25px;
            font-size: 1.1em;
            cursor: pointer;
            border: 1px solid var(--accent-color);
            background-color: var(--accent-color);
            color: white;
            border-radius: 5px;
            margin: 0 10px 20px 10px;
        }
        .initial-actions button:hover {
            background-color: var(--accent-color-hover);
            border-color: var(--accent-color-hover);
        }

        .card-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            margin-top: 40px;
        }
        /* ---- ESTILOS DOS CARDS MODIFICADOS PARA SEREM MENORES ---- */
        .card {
            background-color: var(--secondary-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px; /* Reduzido de 25px */
            min-width: 160px; /* Reduzido de 180px */
            text-align: center;
            text-decoration: none;
            color: var(--text-color);
            font-size: 1em; /* Reduzido de 1.1em */
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.4);
            color: var(--accent-color-hover);
        }

        #docTitle {
            width: calc(100% - 22px);
            padding: 10px;
            font-size: 1.5em;
            margin-bottom: 10px;
            border: 1px solid #555;
            border-radius: 4px;
            background-color: #252525;
            color: #d4d4d4 !important;
        }
        .chapter-wrapper {
            position: relative;
            margin-bottom: 25px;
            padding-top: 40px;
            border: 1px solid #3a3a3a;
            border-radius: 4px;
            background-color: #252525;
        }
        .chapter-wrapper.active-chapter-wrapper {
            border-color: #5a90c2;
            box-shadow: 0 0 0 1px rgba(58, 124, 165, 0.25);
        }
        .chapter-toolbar {
            position: -webkit-sticky;
            position: sticky;
            top: 6px;
            display: flex;
            gap: 6px;
            background-color: rgba(56, 56, 56, 0.85);
            padding: 5px;
            border-radius: 4px;
            z-index: 10;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            margin-left: auto;
            width: fit-content;
        }
        .chapter-toolbar button {
            background: none;
            border: 1px solid #666;
            color: #c0c0c0;
            font-size: 1.1em;
            padding: 2px 6px;
            cursor: pointer;
            border-radius: 3px;
            line-height: 1;
        }
        .chapter-toolbar button:hover {
            background-color: #4f4f4f;
            border-color: #777;
            color: #e0e0e0;
        }
        .chapter-toolbar button:disabled {
            color: #777 !important;
            cursor: not-allowed !important;
            background-color: #383838 !important;
            border-color: #555 !important;
            opacity: 0.6;
        }
    
        #editorsContainer .text-editor-chapter {
            min-height: 100px;
            border: none;
            padding: 10px 15px;
            outline: none;
            line-height: 1.6;
            background-color: transparent;
            color: #d4d4d4;
        }
        #editorsContainer .text-editor-chapter .referenced-text {
            background-color: #384858;
            padding: 1px 2px;
            border-radius: 3px;
            cursor: default;
            color: #a8c8e8;
        }
        #editorsContainer .text-editor-chapter .referenced-text.eye-icon-active {
            background-color: #304050;
            outline: 1px dotted #7aa0c7;
        }
        #editorsContainer .text-editor-chapter .referenced-text.referenced-text-empty {
            color: #FF6B6B;
            border-bottom: 1px dashed #FF6B6B;
        }
        #editorsContainer .text-editor-chapter .referenced-text.referenced-text-empty::before {
            content: "[vazio]";
            font-style: italic;
            color: #FF8B8B;
        }
        .toolbar {
            position: absolute;
            background: #444;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            z-index: 1000;
            display: flex;
            gap: 5px;
        }
        .toolbar button {
            background: none;
            border: none;
            color: white;
            font-size: 1.2em;
            cursor: pointer;
        }
        .toolbar button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    
        #documentsListContainer, #hiddenChaptersListContainer, #backupListContainer, .scrollable-ref-list {
            flex-grow: 1; 
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 20px;
            border: 1px solid #444;
            border-radius: 4px;
            padding: 5px;
        }
        #hiddenChaptersListContainer ul, #backupListContainer ul, #documentsListContainer ul, .scrollable-ref-list ul {
            list-style: none;
            padding: 0;
        }
        #hiddenChaptersListContainer li, #backupListContainer li, #documentsListContainer li, .scrollable-ref-list .ref-list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #404040;
        }
        .scrollable-ref-list .ref-list-item {
            cursor: pointer;
            list-style-type: none;
        }
        .scrollable-ref-list .ref-list-item:hover, #backupListContainer li:hover {
            background-color: #3a3a3a;
        }
        .scrollable-ref-list .ref-list-item.selected {
            background-color: #3a7ca5;
            color: white;
        }
        #backupListContainer li {
            cursor: pointer;
        }
        
        .popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s ease, visibility 0s linear 0.3s;
        }
        .popup.active {
            visibility: visible;
            opacity: 1;
            transition: opacity 0.3s ease;
        }
        .popup-content {
            background: #333;
            color: #d4d4d4;
            padding: 25px;
            border-radius: 8px;
            width: 450px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }
        .popup-content h3 {
            margin-top: 0;
            margin-bottom: 15px;
        }
        .popup-content input, .popup-content button {
            padding: 10px 15px;
            border: 1px solid #555;
            border-radius: 4px;
            background-color: #252525;
            color: #d4d4d4;
        }
        .popup-content button {
            cursor: pointer;
            background-color: #5a6268;
            border: none;
        }
        .popup-content button:hover {
            background-color: #6c757d;
        }
        .popup-content .popup-actions {
            margin-top: auto;
            padding-top: 15px;
            border-top: 1px solid #444;
            text-align: right;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        .popup-content .popup-actions button {
            margin-left: 0;
        }
        .popup-content button.save-btn, .popup-content button.confirm-btn {
            background-color: #4CAF50;
        }
        .popup-content button.save-btn:hover, .popup-content button.confirm-btn:hover {
            background-color: #5cb85c;
        }
        .popup-content button.danger-btn {
            background-color: #d9534f;
        }
         .popup-content button.danger-btn:hover {
            background-color: #c9302c;
        }
        .edit-btn {
            background-color: #3a7ca5 !important;
            border-color: #3a7ca5 !important;
            color: white !important;
        }
        .edit-btn:hover {
            background-color: #4a90c2 !important;
            border-color: #4a90c2 !important;
        }
        .restore-btn {
            background-color: #f0ad4e !important;
            border-color: #eea236 !important;
            color: white !important;
        }
        .restore-btn:hover {
            background-color: #ec971f !important;
            border-color: #d58512 !important;
        }
        .url-input-group {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        .url-input-group input {
            flex-grow: 1;
        }
        .url-input-group button {
            flex-shrink: 0;
            margin-left: 10px;
            padding: 8px 12px;
        }
    
        #referencesSection {
            margin-top: 30px;
            border-top: 1px solid #444;
            padding-top: 20px;
        }
        #referencesList {
            list-style: none;
            padding: 0;
        }
        #referencesList li {
            background: #353535;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            position: relative;
        }
        #referencesList li .ref-title {
            font-weight: bold;
            cursor: pointer;
            color: #b0c4de;
        }
         #referencesList li .ref-title:hover {
            text-decoration: underline;
        }
        .edit-ref-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: none;
            border: none;
            cursor: pointer;
            color: #999;
        }
        .edit-ref-btn:hover {
            color: #fff;
        }
        #archiveDocBtn {
            display: block;
            width: 100%;
            margin-top: 20px;
            padding: 10px;
            background-color: #d9534f;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
        }
        #archiveDocBtn:hover {
            background-color: #c9302c;
        }
    
        #editorsContainer .text-editor-chapter .referenced-text.highlight-scroll, .reference-item.highlight-scroll {
            background-color: rgba(255, 223, 100, 0.25) !important;
            border-bottom: 2px solid #FFC107;
        }
    </style>
</head>
<body>
    <div id="initialScreen">
        <h1>Meu Editor</h1>
        <div class="initial-actions">
            <button id="initNewDocBtn">Novo Documnento</button>
            <button id="initLoadDocBtn">Carregar Documento</button>
        </div>
        <div class="card-container">
            <a href="studiomusic.html" class="card">Studio: Music</a>
            <a href="timelinekings.html" class="card">Cronologia: Reis</a>
            <a href="cronos.html" class="card">Cronologia: Mundial</a>
            <a href="notes.html" class="card">Studio: Notas</a>
        </div>
    </div>
    <div id="editorInterface" style="display: none;"><div class="container"><div class="doc-actions" style="margin-bottom: 15px; display: flex; gap: 10px; justify-content: flex-end;"><button id="backToInitialScreenBtn">Voltar</button><button id="showHiddenBtn">Ocultos</button><button id="showBackupBtn">Backup</button></div><input type="text" id="docTitle" placeholder="Título"><div id="editorsContainer"></div><button id="addChapterBtn">+ Capítulo</button><div id="floatingToolbar" class="toolbar" style="display: none;"><button id="attachLinkBtn">🔗</button><button id="appendToRefBtn">➕🔗</button><button id="removeLinkBtn">🚫</button></div><div id="referencesSection"><h2>Referências</h2><ul id="referencesList"></ul></div><button id="archiveDocBtn">Arquivar Documento</button></div></div>
    <div id="referenceEyeToolbar" class="toolbar" style="display: none;"><button id="viewReferenceFromToolbarBtn">👁️</button><button id="splitAndInsertBtn">✂️+📝</button></div>
    <div id="hiddenChaptersPopup" class="popup"><div class="popup-content"><h3>Ocultos</h3><div id="hiddenChaptersListContainer"><ul></ul><p>Nenhum.</p></div><div class="popup-actions"><button class="close-popup-btn">Fechar</button></div></div></div>
    <div id="backupPopup" class="popup"><div class="popup-content"><h3>Backups</h3><button id="createBackupBtn" style="width:100%; margin-bottom: 20px;">Criar Backup</button><div id="backupListContainer"><ul></ul><p>Nenhum.</p></div><div class="popup-actions"><button class="close-popup-btn">Fechar</button></div></div></div>
    <div id="addReferencePopup" class="popup"><div class="popup-content"><h3>Adicionar Referência</h3><input type="text" id="refTitleInput" placeholder="Título"><div id="addRefUrlsContainer"></div><button type="button" id="addMoreUrlsToAddPopupBtn">+ URL</button><div class="popup-actions"><button id="saveNewRefBtnElement" class="save-btn">Salvar</button><button class="close-popup-btn">Cancelar</button></div></div></div>
    <div id="editReferencePopup" class="popup"><div class="popup-content"><h3>Editar Referência</h3><input type="text" id="editRefTitleInput" placeholder="Título"><div id="editRefUrlsContainer"></div><button type="button" id="addMoreUrlsToEditPopupBtn">+ URL</button><input type="hidden" id="editingRefIdInput"><div class="popup-actions"><button id="saveEditedRefBtn" class="save-btn">Salvar</button><button id="deleteRefBtn" class="danger-btn">Excluir</button><button class="close-popup-btn">Cancelar</button></div></div></div>
    <div id="loadDocumentPopup" class="popup"><div class="popup-content"><h3>Carregar Documento Existente</h3><div id="documentsListContainer"><p>Carregando...</p><ul></ul></div><div class="popup-actions"></div></div></div>
    <div id="selectExistingRefPopup" class="popup"><div class="popup-content"><h3>Anexar</h3><div id="existingRefListContainer" class="scrollable-ref-list"><ul></ul></div><div class="popup-actions"><button id="confirmAppendRefBtn" disabled>Anexar</button><button class="close-popup-btn">Cancelar</button></div></div></div>
    <div id="splitChapterPopup" class="popup"><div class="popup-content"><h3>Dividir</h3><p>Criar novo capítulo?</p><div class="popup-actions"><button id="confirmSplitBtn" class="confirm-btn">Sim</button><button id="cancelSplitBtn" class="close-popup-btn">Não</button></div></div></div>

    <script type="module">
        const firebaseConfig = {
            apiKey: "AIzaSyAhunMuQHzK-Mp8DaXb1bRFLGTem5GZfjY", authDomain: "bibliacontexto.firebaseapp.com", projectId: "bibliacontexto", storageBucket: "bibliacontexto.firebasestorage.app", messagingSenderId: "266293600679", appId: "1:266293600679:web:3b7c264f0b5e35ebea1682"
        };
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, getDocs, addDoc, query, where, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        let app, db;
        try { app = initializeApp(firebaseConfig); db = getFirestore(app); console.log("Firebase inicializado!"); } catch (e) { console.error("ERRO AO INICIALIZAR O FIREBASE:", e); alert("Falha na conexão com o Firebase."); throw e; }

        const initialScreenDiv=document.getElementById('initialScreen'),editorInterfaceDiv=document.getElementById('editorInterface'),initNewDocBtn=document.getElementById('initNewDocBtn'),initLoadDocBtn=document.getElementById('initLoadDocBtn'),backToInitialScreenBtn=document.getElementById('backToInitialScreenBtn'),editorsContainer=document.getElementById('editorsContainer'),addChapterBtn=document.getElementById('addChapterBtn'),floatingToolbar=document.getElementById('floatingToolbar'),attachLinkBtn=document.getElementById('attachLinkBtn'),removeLinkBtn=document.getElementById('removeLinkBtn'),appendToRefBtn=document.getElementById('appendToRefBtn'),docTitleInput=document.getElementById('docTitle'),referencesListUl=document.getElementById('referencesList'),addReferencePopup=document.getElementById('addReferencePopup'),refTitleInput=document.getElementById('refTitleInput'),saveNewRefBtnElement=document.getElementById('saveNewRefBtnElement'),editReferencePopup=document.getElementById('editReferencePopup'),editRefTitleInput=document.getElementById('editRefTitleInput'),editingRefIdInput=document.getElementById('editingRefIdInput'),saveEditedRefBtn=document.getElementById('saveEditedRefBtn'),deleteRefBtn=document.getElementById('deleteRefBtn'),loadDocumentPopup=document.getElementById('loadDocumentPopup'),documentsListContainerUl=document.querySelector('#documentsListContainer ul'),documentsListContainerMsg=document.querySelector('#documentsListContainer p'),addMoreUrlsToAddPopupBtn=document.getElementById('addMoreUrlsToAddPopupBtn'),addMoreUrlsToEditPopupBtn=document.getElementById('addMoreUrlsToEditPopupBtn'),referenceEyeToolbar=document.getElementById('referenceEyeToolbar'),viewReferenceFromToolbarBtn=document.getElementById('viewReferenceFromToolbarBtn'),splitAndInsertBtn=document.getElementById('splitAndInsertBtn'),selectExistingRefPopup=document.getElementById('selectExistingRefPopup'),existingRefListContainer=document.getElementById('existingRefListContainer'),confirmAppendRefBtn=document.getElementById('confirmAppendRefBtn'),splitChapterPopup=document.getElementById('splitChapterPopup'),confirmSplitBtn=document.getElementById('confirmSplitBtn'),cancelSplitBtn=document.getElementById('cancelSplitBtn'),showHiddenBtn=document.getElementById('showHiddenBtn'),showBackupBtn=document.getElementById('showBackupBtn'),backupPopup=document.getElementById('backupPopup'),createBackupBtn=document.getElementById('createBackupBtn'),backupListContainer=document.getElementById('backupListContainer'),archiveDocBtn=document.getElementById('archiveDocBtn');
        
        let currentDocId, currentDocumentData, debounceTimer, currentSelectionRange, rangeForPendingReference, activeEditorElement, activeReferencedTextSpanForEye, rangeForSplitting, rangeForSplittingChapter;
        let undoStack = [], redoStack = [];
        const DEFAULT_FONT_SIZE = '25px', DEFAULT_FONT_FAMILY = 'Arial, sans-serif', DEFAULT_LINE_HEIGHT = '1.6';

        function generateId(p='e-'){return p+Date.now()+'-'+Math.random().toString(36).substring(2,7)}
        function showPopup(el){if(el)el.classList.add('active')}
        function hidePopup(el){if(el)el.classList.remove('active')}
        function applyDefaultStylesToBlocks(c){if(!c)return;c.querySelectorAll('p, div').forEach(el=>{if(!el.style.fontSize)el.style.fontSize=DEFAULT_FONT_SIZE;if(!el.style.lineHeight)el.style.lineHeight=DEFAULT_LINE_HEIGHT;})}
            function escapeHTML(str) { if (typeof str !== 'string') return ''; const map = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&apos;', '`': '&#96;' }; return str.replace(/[&<>"'`]/g, function(tag) { return map[tag] || tag; }); }        function createUrlInputEntry(cId,val='',canRemove=true){const c=document.getElementById(cId);if(!c)return;const ig=document.createElement('div');ig.className='url-input-group';const ui=document.createElement('input');ui.type='url';ui.className='ref-url-input';ui.placeholder='URL';ui.value=val;ig.appendChild(ui);if(canRemove){const rb=document.createElement('button');rb.type='button';rb.textContent='X';rb.addEventListener('click',()=>{ig.remove();if(c.childElementCount===0)createUrlInputEntry(c.id,'',false)});ig.appendChild(rb)}c.appendChild(ig)}
        function formatDate(ts){if(!ts||!ts.toDate)return'Data inválida';const d=ts.toDate();return`${String(d.getDate()).padStart(2,'0')}/${String(d.getMonth()+1).padStart(2,'0')}/${d.getFullYear()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`}
        
        function syncDocumentStateFromDOM(){if(!editorsContainer||!currentDocumentData)return;currentDocumentData.titulo=docTitleInput.value.trim()||"Sem Título";const order=Array.from(editorsContainer.querySelectorAll('.chapter-wrapper')).map(w=>w.dataset.chapterId);const existingChapterIds=new Set(currentDocumentData.corpo.map(ch=>ch.id));editorsContainer.querySelectorAll('.chapter-wrapper').forEach(wrapper=>{if(!existingChapterIds.has(wrapper.dataset.chapterId)){currentDocumentData.corpo.push({id:wrapper.dataset.chapterId,html:'',isHidden:wrapper.style.display==='none'})}});currentDocumentData.corpo.sort((a,b)=>order.indexOf(a.id)-order.indexOf(b.id));currentDocumentData.corpo.forEach(ch=>{const wrapper=editorsContainer.querySelector(`.chapter-wrapper[data-chapter-id="${ch.id}"]`);if(wrapper&&wrapper.style.display!=='none'){ch.html=wrapper.querySelector('.text-editor-chapter').innerHTML}})}
        function saveStateForUndo(){if(!currentDocumentData)return;syncDocumentStateFromDOM();undoStack.push(JSON.parse(JSON.stringify(currentDocumentData)));redoStack=[];if(undoStack.length>30)undoStack.shift()}
        async function handleUndo(){if(undoStack.length===0)return;redoStack.push(JSON.parse(JSON.stringify(currentDocumentData)));const state=undoStack.pop();try{currentDocumentData=state;await updateDoc(doc(db,"documentos",currentDocId),{titulo:state.titulo,corpo:state.corpo,referencias:state.referencias,atualizadoEm:serverTimestamp()});displayDocumentContent(state.titulo,state.corpo,state.referencias)}catch(e){console.error("Erro ao desfazer:",e);undoStack.push(state);redoStack.pop();alert("Erro ao desfazer.")}}
        async function handleRedo(){if(redoStack.length===0)return;undoStack.push(JSON.parse(JSON.stringify(currentDocumentData)));const state=redoStack.pop();try{currentDocumentData=state;await updateDoc(doc(db,"documentos",currentDocId),{titulo:state.titulo,corpo:state.corpo,referencias:state.referencias,atualizadoEm:serverTimestamp()});displayDocumentContent(state.titulo,state.corpo,state.referencias)}catch(e){console.error("Erro ao refazer:",e);redoStack.push(state);undoStack.pop();alert("Erro ao refazer.")}}
        
        function hideFloatingToolbar(){if(floatingToolbar)floatingToolbar.style.display='none'}
        function showFloatingToolbar(){if(!currentSelectionRange||!activeEditorElement||!floatingToolbar||currentSelectionRange.collapsed)return;const r=currentSelectionRange.getBoundingClientRect();floatingToolbar.style.left=`${r.left+window.scrollX+(r.width/2)-(floatingToolbar.offsetWidth/2)}px`;floatingToolbar.style.top=`${r.top+window.scrollY-floatingToolbar.offsetHeight-10}px`;floatingToolbar.style.display='flex';const el=currentSelectionRange.commonAncestorContainer.nodeType===Node.ELEMENT_NODE?currentSelectionRange.commonAncestorContainer:currentSelectionRange.commonAncestorContainer.parentElement;const inRef=el.closest('span.referenced-text[data-ref-id]');attachLinkBtn.disabled=!!inRef;removeLinkBtn.disabled=!inRef;appendToRefBtn.disabled=!!inRef||!(currentDocumentData?.referencias?.length>0)}
        function hideReferenceEyeToolbar(){if(referenceEyeToolbar)referenceEyeToolbar.style.display='none';if(activeReferencedTextSpanForEye){activeReferencedTextSpanForEye.classList.remove('eye-icon-active');activeReferencedTextSpanForEye=null}}
        function showReferenceEyeToolbar(span){if(!referenceEyeToolbar||!span)return;hideFloatingToolbar();const r=span.getBoundingClientRect();referenceEyeToolbar.style.left=`${r.left+window.scrollX+(r.width/2)-(referenceEyeToolbar.offsetWidth/2)}px`;referenceEyeToolbar.style.top=`${r.top+window.scrollY-referenceEyeToolbar.offsetHeight-5}px`;referenceEyeToolbar.style.display='flex';referenceEyeToolbar.dataset.refId=span.dataset.refId;splitAndInsertBtn.disabled=!span.closest('.text-editor-chapter');if(activeReferencedTextSpanForEye&&activeReferencedTextSpanForEye!==span)activeReferencedTextSpanForEye.classList.remove('eye-icon-active');activeReferencedTextSpanForEye=span;activeReferencedTextSpanForEye.classList.add('eye-icon-active')}
        
        function showEditorInterfaceScreen(){initialScreenDiv.style.display='none';editorInterfaceDiv.style.display='block'}
        async function showInitialScreen(){editorInterfaceDiv.style.display='none';initialScreenDiv.style.display='block';currentDocId=null;currentDocumentData=null;docTitleInput.value='';editorsContainer.innerHTML='';referencesListUl.innerHTML="<li>Nenhuma referência.</li>";hideFloatingToolbar();hideReferenceEyeToolbar()}
        
        async function createNewDocument(){undoStack=[];redoStack=[];showEditorInterfaceScreen();currentDocId=generateId('doc-');const chId=generateId('ch-');currentDocumentData={titulo:"Novo Documento",corpo:[{id:chId,html:''}],referencias:[],criadoEm:serverTimestamp(),atualizadoEm:serverTimestamp(),ativo:true};try{await setDoc(doc(db,"documentos",currentDocId),currentDocumentData);displayDocumentContent(currentDocumentData.titulo,currentDocumentData.corpo,currentDocumentData.referencias)}catch(e){console.error("Erro ao criar documento:",e);alert("Erro ao criar documento.")}}
        async function loadDocument(id){if(!id)return;undoStack=[];redoStack=[];showEditorInterfaceScreen();editorsContainer.innerHTML="<p>Carregando...</p>";docTitleInput.value="Carregando...";currentDocId=id;try{const docSnap=await getDoc(doc(db,"documentos",currentDocId));if(docSnap.exists()){currentDocumentData=docSnap.data();displayDocumentContent(currentDocumentData.titulo,currentDocumentData.corpo,currentDocumentData.referencias)}else{alert("Documento não encontrado.");editorsContainer.innerHTML="<p>Documento não encontrado.</p>"}}catch(e){console.error("Erro ao carregar documento:",e);alert("Erro ao carregar o documento.");editorsContainer.innerHTML=`<p style="color:red;">Falha ao carregar: ${e.message}</p>`}}
        async function saveDocumentBody(force=false){if(!currentDocId||!force)return;syncDocumentStateFromDOM();try{await updateDoc(doc(db,"documentos",currentDocId),{corpo:currentDocumentData.corpo,atualizadoEm:serverTimestamp()})}catch(e){console.error("Erro ao salvar corpo:",e)}}
        async function saveDocumentTitle(){if(!currentDocId)return;const title=docTitleInput.value.trim()||"Sem Título";saveStateForUndo();try{await updateDoc(doc(db,"documentos",currentDocId),{titulo:title,atualizadoEm:serverTimestamp()});if(currentDocumentData)currentDocumentData.titulo=title}catch(e){console.error("Erro ao salvar título:",e)}}
        function displayDocumentContent(title,corpo,refs){docTitleInput.value=title||"";editorsContainer.innerHTML='';activeEditorElement=null;(corpo&&corpo.length>0?corpo:[{id:generateId('ch-'),html:''}]).forEach(ch=>{const w=createNewChapterElement(ch.html,ch.id);if(ch.isHidden)w.style.display='none'});updateChapterActionButtonsState();renderReferences()}
        
        function updateEmptyReferenceSpansStyles(c){if(!c)return;c.querySelectorAll('span.referenced-text[data-ref-id]').forEach(s=>s.classList.toggle('referenced-text-empty',s.textContent.trim()===''))}
        function createNewChapterElement(html='',id=null,focus=false){const wrapper=document.createElement('div');wrapper.className='chapter-wrapper';wrapper.dataset.chapterId=id||generateId('ch-');const toolbar=document.createElement('div');toolbar.className='chapter-toolbar';toolbar.innerHTML=`<button title="Cima">🔼</button><button title="Baixo">🔽</button><button title="Desfazer">↶</button><button title="Refazer">↷</button><button title="Fonte">T</button><button title="Tamanho">Aa</button><button title="Ocultar">🗑️</button><button title="Dividir">🔨</button>`;toolbar.children[0].addEventListener('click',e=>{e.stopPropagation();handleMoveChapter(wrapper,'up')});toolbar.children[1].addEventListener('click',e=>{e.stopPropagation();handleMoveChapter(wrapper,'down')});toolbar.children[2].addEventListener('click',e=>{e.stopPropagation();handleUndo()});toolbar.children[3].addEventListener('click',e=>{e.stopPropagation();handleRedo()});toolbar.children[4].addEventListener('click',e=>{e.stopPropagation();handleFormatFontFamily(wrapper)});toolbar.children[5].addEventListener('click',e=>{e.stopPropagation();handleFormatFontSize(wrapper)});toolbar.children[6].addEventListener('click',e=>{e.stopPropagation();handleHideChapter(wrapper)});toolbar.children[7].addEventListener('click',e=>{e.stopPropagation();const editor=wrapper.querySelector('.text-editor-chapter');const sel=window.getSelection();if(sel.rangeCount>0&&editor.contains(sel.anchorNode))showSplitChapterPopup(wrapper,sel.getRangeAt(0));else alert("Clique no texto para dividir.")});wrapper.appendChild(toolbar);const chapterDiv=document.createElement('div');chapterDiv.className='text-editor-chapter';chapterDiv.setAttribute('contenteditable','true');chapterDiv.innerHTML=html.trim()===''?`<p style="font-family:${DEFAULT_FONT_FAMILY};font-size:${DEFAULT_FONT_SIZE};line-height:${DEFAULT_LINE_HEIGHT};"><br></p>`:html;applyDefaultStylesToBlocks(chapterDiv);updateEmptyReferenceSpansStyles(chapterDiv);let typingSaved=false;chapterDiv.addEventListener('focus',()=>{activeEditorElement=chapterDiv;document.querySelectorAll('.chapter-wrapper.active-chapter-wrapper').forEach(w=>w.classList.remove('active-chapter-wrapper'));wrapper.classList.add('active-chapter-wrapper');typingSaved=false});chapterDiv.addEventListener('input',()=>{const sel=window.getSelection();if(sel&&sel.isCollapsed&&sel.rangeCount>0){const n=sel.getRangeAt(0).startContainer;if(n.nodeType===Node.TEXT_NODE&&n.parentNode.classList.contains('referenced-text')){const s=n.parentNode;if(/\s+$/.test(n.textContent)&&sel.getRangeAt(0).startOffset===n.textContent.length){const sp=n.textContent.match(/\s+$/)[0];n.textContent=n.textContent.replace(/\s+$/,'');const sn=document.createTextNode(sp);s.parentNode.insertBefore(sn,s.nextSibling);const nr=document.createRange();nr.setStart(sn,sn.length);nr.collapse(true);sel.removeAllRanges();sel.addRange(nr)}}}if(!typingSaved){saveStateForUndo();typingSaved=true}clearTimeout(debounceTimer);debounceTimer=setTimeout(()=>{if(activeEditorElement===chapterDiv){applyDefaultStylesToBlocks(chapterDiv);updateEmptyReferenceSpansStyles(chapterDiv);saveDocumentBody(true)}},1500)});chapterDiv.addEventListener('paste',e=>{saveStateForUndo();e.preventDefault();const text=(e.clipboardData||window.clipboardData).getData('text/plain');if(text){document.execCommand('insertText',false,text);setTimeout(()=>{if(activeEditorElement){applyDefaultStylesToBlocks(activeEditorElement);updateEmptyReferenceSpansStyles(activeEditorElement)}saveDocumentBody(true)},0)}});chapterDiv.addEventListener('keydown',e=>{if(e.key==='Enter'){const sel=window.getSelection();if(!sel||!sel.rangeCount)return;const range=sel.getRangeAt(0);const span=range.startContainer.parentElement.closest('span.referenced-text');if(span){e.preventDefault();saveStateForUndo();const block=span.closest('p, div');if(isCursorAtEnd(span,range)){const p=document.createElement('p');p.innerHTML='<br>';Object.assign(p.style,{fontFamily:DEFAULT_FONT_FAMILY,fontSize:DEFAULT_FONT_SIZE,lineHeight:DEFAULT_LINE_HEIGHT});block.parentNode.insertBefore(p,block.nextSibling);sel.collapse(p,0)}else{const endRange=document.createRange();endRange.setStart(range.startContainer,range.startOffset);endRange.setEnd(block,block.childNodes.length);const content=endRange.extractContents();const p=document.createElement('p');p.appendChild(content);if(p.innerHTML.trim()==='')p.innerHTML='<br>';Object.assign(p.style,{fontFamily:getComputedStyle(block).fontFamily,fontSize:getComputedStyle(block).fontSize,lineHeight:getComputedStyle(block).lineHeight});block.parentNode.insertBefore(p,block.nextSibling);sel.collapse(p,0)}saveDocumentBody(true)}}});function isCursorAtEnd(el,r){if(!r.collapsed)return false;const tr=r.cloneRange();tr.selectNodeContents(el);tr.setStart(r.endContainer,r.endOffset);return tr.toString().trim()===''}wrapper.appendChild(chapterDiv);editorsContainer.appendChild(wrapper);updateChapterActionButtonsState();if(focus){placeCursorAtEndOf(chapterDiv);chapterDiv.focus({preventScroll:true});activeEditorElement=chapterDiv}return wrapper}
        function updateChapterActionButtonsState(){const w=Array.from(editorsContainer.querySelectorAll('.chapter-wrapper'));w.forEach((el,i)=>{const up=el.querySelector('.chapter-toolbar button:nth-child(1)');if(up)up.disabled=(i===0);const down=el.querySelector('.chapter-toolbar button:nth-child(2)');if(down)down.disabled=(i===w.length-1);const rem=el.querySelector('.chapter-toolbar button:nth-child(7)');if(rem)rem.disabled=(w.length<=1)})}
        function handleHideChapter(w){if(editorsContainer.querySelectorAll('.chapter-wrapper:not([style*="display: none"])').length<=1)return alert("Não pode ocultar.");if(window.confirm("Ocultar capítulo?")){saveStateForUndo();const id=w.dataset.chapterId;const i=currentDocumentData.corpo.findIndex(c=>c.id===id);if(i>-1){currentDocumentData.corpo[i].isHidden=true;w.style.display='none';updateChapterActionButtonsState();saveDocumentBody(true)}}}
        function handleFormatFontFamily(w){const e=w.querySelector('.text-editor-chapter');if(!e)return;saveStateForUndo();e.querySelectorAll('p, div, span, strong, em, b, i, u').forEach(el=>el.style.fontFamily=DEFAULT_FONT_FAMILY);saveDocumentBody(true);alert('Fonte formatada.')}
        function handleFormatFontSize(w){const e=w.querySelector('.text-editor-chapter');if(!e)return;saveStateForUndo();e.querySelectorAll('p, div, span, strong, em, b, i, u').forEach(el=>el.style.fontSize=DEFAULT_FONT_SIZE);saveDocumentBody(true);alert('Tamanho formatado.')}
        function handleMoveChapter(w,dir){const s=dir==='up'?w.previousElementSibling:w.nextElementSibling;if(s){saveStateForUndo();const p=w.parentNode;p.insertBefore(dir==='up'?w:s,dir==='up'?s:w);updateChapterActionButtonsState();saveDocumentBody(true)}}
        function placeCursorAtEndOf(el){if(!el)return;const s=window.getSelection();const r=document.createRange();r.selectNodeContents(el);r.collapse(false);s.removeAllRanges();s.addRange(r)}
        
        function showAddReferencePopup(){if(!activeEditorElement||!currentSelectionRange||currentSelectionRange.collapsed)return alert("Selecione texto para criar o link.");rangeForPendingReference=currentSelectionRange.cloneRange();refTitleInput.value="";document.getElementById('addRefUrlsContainer').innerHTML='';createUrlInputEntry('addRefUrlsContainer','',false);showPopup(addReferencePopup);refTitleInput.focus()}
        async function addReferenceToDocument(title){saveStateForUndo();if(!rangeForPendingReference){alert("Nenhuma seleção.");hidePopup(addReferencePopup);return}const urls=Array.from(document.querySelectorAll('#addRefUrlsContainer .ref-url-input')).map(i=>i.value.trim()).filter(Boolean);if(urls.length===0)return alert("Pelo menos uma URL.");const newRef={id:generateId('ref-'),tituloReferencia:title,urls:urls};const span=document.createElement('span');span.className='referenced-text';span.dataset.refId=newRef.id;try{rangeForPendingReference.surroundContents(span);if(!currentDocumentData.referencias)currentDocumentData.referencias=[];currentDocumentData.referencias.push(newRef);await saveDocumentBody(true);await updateDoc(doc(db,"documentos",currentDocId),{referencias:currentDocumentData.referencias});renderReferences();updateEmptyReferenceSpansStyles(span.closest('.text-editor-chapter'));hidePopup(addReferencePopup);rangeForPendingReference=null}catch(e){console.error("Falha ao salvar referência:",e);alert("Erro ao salvar.")}}
        function renderReferences(){if(!referencesListUl||!editorsContainer)return;referencesListUl.innerHTML="";const refs=currentDocumentData?.referencias||[];if(refs.length===0){referencesListUl.innerHTML="<li>Nenhuma referência.</li>";return}const idsInText=new Set(Array.from(editorsContainer.querySelectorAll('span.referenced-text[data-ref-id]')).map(s=>s.dataset.refId));refs.forEach(r=>{const li=document.createElement('li');li.className='reference-item';li.classList.toggle('reference-item-unlinked',!idsInText.has(r.id));li.dataset.refId=r.id;const urlsHTML=(r.urls||[]).map(u=>`<a>${escapeHTML(u)}</a>`).join('<br>');li.innerHTML=`<div class="ref-content"><span class="ref-title" data-ref-id="${r.id}">${escapeHTML(r.tituloReferencia)}:</span><div style="margin-top:3px;font-size:0.9em;">${urlsHTML}</div></div><button class="edit-ref-btn" data-ref-id="${r.id}">✎</button>`;referencesListUl.appendChild(li)})}
        function openEditReferencePopup(id){const r=currentDocumentData?.referencias.find(ref=>ref.id===id);if(!r)return;editingRefIdInput.value=id;editRefTitleInput.value=r.tituloReferencia;const c=document.getElementById('editRefUrlsContainer');c.innerHTML='';(r.urls||[]).forEach(u=>createUrlInputEntry('editRefUrlsContainer',u,true));if((r.urls||[]).length===0)createUrlInputEntry('editRefUrlsContainer','',false);showPopup(editReferencePopup)}
        async function saveEditedReference(){const id=editingRefIdInput.value,title=editRefTitleInput.value.trim();if(!id||!title)return alert("Título obrigatório.");saveStateForUndo();const urls=Array.from(document.querySelectorAll('#editRefUrlsContainer .ref-url-input')).map(i=>i.value.trim()).filter(Boolean);if(urls.length===0)return alert("Pelo menos uma URL.");const i=currentDocumentData.referencias.findIndex(r=>r.id===id);if(i>-1){currentDocumentData.referencias[i].tituloReferencia=title;currentDocumentData.referencias[i].urls=urls;await updateDoc(doc(db,"documentos",currentDocId),{referencias:currentDocumentData.referencias});renderReferences();hidePopup(editReferencePopup)}}
        async function deleteReference(){const id=editingRefIdInput.value;if(!id||!window.confirm("Excluir referência e marcações?"))return;saveStateForUndo();editorsContainer.querySelectorAll(`span.referenced-text[data-ref-id="${id}"]`).forEach(s=>s.replaceWith(s.textContent));currentDocumentData.referencias=currentDocumentData.referencias.filter(r=>r.id!==id);await saveDocumentBody(true);await updateDoc(doc(db,"documentos",currentDocId),{referencias:currentDocumentData.referencias});renderReferences();hidePopup(editReferencePopup)}
        async function handleUnlinkSelection(){const el=currentSelectionRange.commonAncestorContainer.nodeType!==Node.ELEMENT_NODE?currentSelectionRange.commonAncestorContainer.parentElement:currentSelectionRange.commonAncestorContainer;const s=el.closest('span.referenced-text[data-ref-id]');if(s){saveStateForUndo();s.replaceWith(s.textContent);hideFloatingToolbar();renderReferences();await saveDocumentBody(true)}else{alert("Seleção não está em um link.")}}
        
        function createLoadPopupActions(actionsContainer, isArchivedView) {
            actionsContainer.innerHTML = ''; 
            const toggleBtn = document.createElement('button');
            toggleBtn.textContent = isArchivedView ? 'Carregar Documento' : 'Recuperar Documento';
            toggleBtn.addEventListener('click', () => {
                if (isArchivedView) {
                    showLoadDocumentsPopup();
                } else {
                    showArchivedDocumentsList();
                }
            });
            const closeBtn = document.createElement('button');
            closeBtn.textContent = 'Fechar';
            closeBtn.className = 'close-popup-btn';
            closeBtn.addEventListener('click', () => hidePopup(loadDocumentPopup));
            actionsContainer.appendChild(toggleBtn);
            actionsContainer.appendChild(closeBtn);
        }

        async function showLoadDocumentsPopup(){if(!loadDocumentPopup)return;showPopup(loadDocumentPopup);loadDocumentPopup.querySelector('h3').textContent = 'Carregar Documento Existente';createLoadPopupActions(loadDocumentPopup.querySelector('.popup-actions'), false);documentsListContainerUl.innerHTML="";documentsListContainerMsg.textContent="Carregando...";documentsListContainerMsg.style.display='block';try{const snap=await getDocs(query(collection(db,"documentos"),where("ativo","!=",false),orderBy("atualizadoEm","desc")));documentsListContainerMsg.style.display=snap.empty?'block':'none';if(snap.empty){documentsListContainerMsg.textContent="Nenhum documento ativo.";return}snap.forEach(d=>{const data=d.data();const li=document.createElement('li');li.innerHTML=`<span>${escapeHTML(data.titulo)||"Sem Título"}</span><button class="edit-btn" data-doc-id="${d.id}">Editar</button>`;li.querySelector('button').addEventListener('click',e=>{hidePopup(loadDocumentPopup);loadDocument(e.target.dataset.docId)});documentsListContainerUl.appendChild(li)})}catch(e){console.error("Erro ao carregar docs:",e);documentsListContainerMsg.textContent="Erro ao carregar."}}
        
        async function handleArchiveDocument() {
            if (!currentDocId) return;
            if (!confirm("Tem a certeza que deseja arquivar este documento? Ele será movido para a lista de recuperação.")) return;
            try {
                await updateDoc(doc(db, "documentos", currentDocId), { ativo: false, atualizadoEm: serverTimestamp() });
                alert("Documento arquivado com sucesso.");
                await showInitialScreen();
            } catch (e) {
                console.error("Erro ao arquivar o documento:", e);
                alert("Ocorreu um erro ao tentar arquivar o documento.");
            }
        }

        async function showArchivedDocumentsList() {
            if (!loadDocumentPopup) return;
            loadDocumentPopup.querySelector('h3').textContent = 'Recuperar Documento Arquivado';
            createLoadPopupActions(loadDocumentPopup.querySelector('.popup-actions'), true);
            documentsListContainerUl.innerHTML = "";
            documentsListContainerMsg.textContent = "Carregando...";
            documentsListContainerMsg.style.display = 'block';
            try {
                const snap = await getDocs(query(collection(db, "documentos"), where("ativo", "==", false), orderBy("atualizadoEm", "desc")));
                documentsListContainerMsg.style.display = snap.empty ? 'block' : 'none';
                if (snap.empty) {
                    documentsListContainerMsg.textContent = "Nenhum documento arquivado.";
                    return;
                }
                snap.forEach(d => {
                    const data = d.data();
                    const li = document.createElement('li');
                    li.innerHTML = `<span>${escapeHTML(data.titulo) || "Sem Título"}</span><button class="restore-btn" data-doc-id="${d.id}">Restaurar</button>`;
                    li.querySelector('button').addEventListener('click', e => handleRestoreDocument(e.target.dataset.docId));
                    documentsListContainerUl.appendChild(li);
                });
            } catch (e) {
                console.error("Erro ao carregar documentos arquivados:", e);
                documentsListContainerMsg.textContent = "Erro ao carregar.";
            }
        }
        
        async function handleRestoreDocument(docId) {
            try {
                await updateDoc(doc(db, "documentos", docId), { ativo: true, atualizadoEm: serverTimestamp() });
                alert("Documento restaurado com sucesso. A carregar para edição...");
                hidePopup(loadDocumentPopup);
                await loadDocument(docId);
            } catch (e) {
                console.error("Erro ao restaurar o documento:", e);
                alert("Ocorreu um erro ao tentar restaurar o documento.");
            }
        }

        function showHiddenChaptersPopup(){const h=(currentDocumentData?.corpo||[]).filter(c=>c.isHidden);const l=document.querySelector('#hiddenChaptersListContainer ul');l.innerHTML='';const m=document.querySelector('#hiddenChaptersListContainer p');if(h.length===0){m.style.display='block';m.textContent="Nenhum capítulo oculto."}else{m.style.display='none';h.forEach(c=>{const t=document.createElement('div');t.innerHTML=c.html;const p=t.textContent.trim().substring(0,80)+'...';const li=document.createElement('li');li.innerHTML=`<span class="chapter-preview" title="${escapeHTML(t.textContent.trim())}">${escapeHTML(p)}</span><button data-chapter-id="${c.id}">Re-exibir</button>`;li.querySelector('button').addEventListener('click',e=>handleUnhideChapter(e.target.dataset.chapterId));l.appendChild(li)})}showPopup(document.getElementById('hiddenChaptersPopup'))}
        async function handleUnhideChapter(id){saveStateForUndo();const i=currentDocumentData.corpo.findIndex(c=>c.id===id);if(i>-1){delete currentDocumentData.corpo[i].isHidden;await saveDocumentBody(true);displayDocumentContent(currentDocumentData.titulo,currentDocumentData.corpo,currentDocumentData.referencias);showHiddenChaptersPopup();if(!(currentDocumentData?.corpo||[]).some(c=>c.isHidden))hidePopup(document.getElementById('hiddenChaptersPopup'))}}
        
        function showSplitChapterPopup(wrapper,range){if(!range.collapsed)return alert("Posicione o cursor para dividir.");rangeForSplittingChapter=range.cloneRange();splitChapterPopup.dataset.sourceChapterId=wrapper.dataset.chapterId;showPopup(splitChapterPopup)}
        async function executeChapterSplit(){const id=splitChapterPopup.dataset.sourceChapterId;if(!id||!rangeForSplittingChapter)return hidePopup(splitChapterPopup);saveStateForUndo();const w=editorsContainer.querySelector(`.chapter-wrapper[data-chapter-id="${id}"]`);const e=w.querySelector('.text-editor-chapter');if(!w||!e)return hidePopup(splitChapterPopup);const r=document.createRange();r.setStart(rangeForSplittingChapter.startContainer,rangeForSplittingChapter.startOffset);r.setEnd(e,e.childNodes.length);const c=r.extractContents();const t=document.createElement('div');t.appendChild(c);let h=t.innerHTML;if(h.trim()==='')h=`<p style="font-family:${DEFAULT_FONT_FAMILY};font-size:${DEFAULT_FONT_SIZE};line-height:${DEFAULT_LINE_HEIGHT};"><br></p>`;if(e.innerHTML.trim()==='')e.innerHTML=`<p style="font-family:${DEFAULT_FONT_FAMILY};font-size:${DEFAULT_FONT_SIZE};line-height:${DEFAULT_LINE_HEIGHT};"><br></p>`;const nw=createNewChapterElement(h,null,false);w.after(nw);rangeForSplittingChapter=null;hidePopup(splitChapterPopup);updateChapterActionButtonsState();saveDocumentBody(true)}

        async function showBackupPopup(){if(!currentDocId)return;const listUl=backupListContainer.querySelector('ul'),msgP=backupListContainer.querySelector('p');listUl.innerHTML='';msgP.textContent='Carregando...';msgP.style.display='block';showPopup(backupPopup);try{const q=query(collection(db,"backups"),where("originalDocId","==",currentDocId),orderBy("backupTimestamp","desc"));const snap=await getDocs(q);if(snap.empty){msgP.textContent='Nenhum backup.'}else{msgP.style.display='none';snap.forEach(docSnap=>{const b=docSnap.data();const li=document.createElement('li');li.dataset.backupId=docSnap.id;li.innerHTML=`<span class="backup-date">${formatDate(b.backupTimestamp)}</span>`;li.addEventListener('click',()=>handleRestoreBackup(docSnap.id));listUl.appendChild(li)})}}catch(e){console.error("Erro ao carregar backups:",e);msgP.textContent='Erro ao carregar.'}}
        async function handleCreateBackup(){if(!currentDocId||!currentDocumentData)return;syncDocumentStateFromDOM();createBackupBtn.disabled=true;createBackupBtn.textContent='A criar...';try{await addDoc(collection(db,"backups"),{originalDocId:currentDocId,backupTimestamp:serverTimestamp(),data:JSON.parse(JSON.stringify(currentDocumentData))});alert('Backup criado!');await showBackupPopup()}catch(e){console.error("Erro ao criar backup:",e);alert('Erro ao criar.')}finally{createBackupBtn.disabled=false;createBackupBtn.textContent='Criar Novo Backup'}}
        async function handleRestoreBackup(id){try{const docSnap=await getDoc(doc(db,"backups",id));if(!docSnap.exists())return alert('Backup não encontrado.');const b=docSnap.data();localStorage.setItem('pendingRestore',JSON.stringify({titulo:`${b.data.titulo} (Backup ${formatDate(b.backupTimestamp)})`,corpo:b.data.corpo,referencias:b.data.referencias}));window.open(window.location.href,'_blank')}catch(e){console.error("Erro ao restaurar backup:",e);alert("Erro ao restaurar.")}}
        async function createNewDocumentFromBackup(data){undoStack=[];redoStack=[];showEditorInterfaceScreen();currentDocId=generateId('doc-');currentDocumentData={...data,criadoEm:serverTimestamp(),atualizadoEm:serverTimestamp()};try{await setDoc(doc(db,"documentos",currentDocId),currentDocumentData);displayDocumentContent(currentDocumentData.titulo,currentDocumentData.corpo,currentDocumentData.referencias)}catch(e){console.error("Erro ao criar doc do backup:",e);await showInitialScreen()}}
        
        function populateExistingRefsList(){if(!existingRefListContainer)return;const ul=existingRefListContainer.querySelector('ul')||document.createElement('ul');ul.innerHTML='';if(!(currentDocumentData?.referencias?.length>0)){ul.innerHTML=`<div class="no-refs-message">Nenhuma referência.</div>`;confirmAppendRefBtn.disabled=true;return}currentDocumentData.referencias.forEach(ref=>{const item=document.createElement('li');item.className='ref-list-item';item.textContent=escapeHTML(ref.tituloReferencia);item.dataset.refId=ref.id;item.addEventListener('click',()=>{ul.querySelector('.selected')?.classList.remove('selected');item.classList.add('selected');confirmAppendRefBtn.disabled=false});ul.appendChild(item)});if(!existingRefListContainer.querySelector('ul'))existingRefListContainer.appendChild(ul);confirmAppendRefBtn.disabled=true}
        
        window.addEventListener('DOMContentLoaded',async()=>{const pendingRestore=localStorage.getItem('pendingRestore');if(pendingRestore){localStorage.removeItem('pendingRestore');try{await createNewDocumentFromBackup(JSON.parse(pendingRestore))}catch(e){console.error("Falha ao processar backup:",e);await showInitialScreen()}}else{await showInitialScreen()}
        function safely(el,ev,fn){if(el)el.addEventListener(ev,fn)}
        safely(initNewDocBtn,'click',createNewDocument);
        safely(initLoadDocBtn,'click',showLoadDocumentsPopup);
        safely(backToInitialScreenBtn,'click',showInitialScreen);
        safely(docTitleInput,'blur',saveDocumentTitle);
        safely(addChapterBtn,'click',()=>{saveStateForUndo();createNewChapterElement('',null,true);saveDocumentBody(true)});
        safely(attachLinkBtn,'click',showAddReferencePopup);
        safely(removeLinkBtn,'click',handleUnlinkSelection);
        safely(appendToRefBtn,'click',()=>{if(!activeEditorElement||!currentSelectionRange||currentSelectionRange.collapsed)return alert("Selecione texto para anexar.");rangeForPendingReference=currentSelectionRange.cloneRange();populateExistingRefsList();showPopup(selectExistingRefPopup)});
        safely(viewReferenceFromToolbarBtn,'click',()=>{const id=referenceEyeToolbar.dataset.refId;if(!id)return;const i=referencesListUl.querySelector(`li.reference-item[data-ref-id="${id}"]`);document.querySelectorAll('.highlight-scroll').forEach(el=>el.classList.remove('highlight-scroll'));if(i){i.scrollIntoView({behavior:'smooth',block:'center'});i.classList.add('highlight-scroll');setTimeout(()=>document.querySelectorAll('.highlight-scroll').forEach(el=>el.classList.remove('highlight-scroll')),2500)}else{alert("Referência não encontrada.")}hideReferenceEyeToolbar()});
        safely(splitAndInsertBtn,'mousedown',e=>{e.preventDefault();if(!rangeForSplitting||!activeEditorElement)return alert("Posição inválida.");saveStateForUndo();const b=rangeForSplitting.startContainer.parentElement.closest('p, div');if(!b)return;const r=document.createRange();r.setStart(rangeForSplitting.startContainer,rangeForSplitting.startOffset);r.setEnd(b,b.childNodes.length);const c=r.extractContents();const p=document.createElement('p');Object.assign(p.style,{fontFamily:DEFAULT_FONT_FAMILY,fontSize:DEFAULT_FONT_SIZE,lineHeight:DEFAULT_LINE_HEIGHT});p.appendChild(c);if(p.innerHTML.trim()==='')p.innerHTML='<br>';b.parentNode.insertBefore(p,b.nextSibling);hideReferenceEyeToolbar();const s=window.getSelection();s.removeAllRanges();s.addRange(rangeForSplitting);activeEditorElement.focus();saveDocumentBody(true);rangeForSplitting=null});
        safely(saveNewRefBtnElement,'click',()=>{if(refTitleInput.value.trim())addReferenceToDocument(refTitleInput.value.trim())});
        safely(saveEditedRefBtn,'click',saveEditedReference);
        safely(deleteRefBtn,'click',deleteReference);
        safely(confirmAppendRefBtn,'click',()=>{const s=existingRefListContainer.querySelector('.selected');if(!s||!rangeForPendingReference)return;saveStateForUndo();const span=document.createElement('span');span.className='referenced-text';span.dataset.refId=s.dataset.refId;try{rangeForPendingReference.surroundContents(span)}catch(e){span.textContent=rangeForPendingReference.toString();rangeForPendingReference.deleteContents();rangeForPendingReference.insertNode(span)}renderReferences();updateEmptyReferenceSpansStyles(span.closest('.text-editor-chapter'));hidePopup(selectExistingRefPopup);saveDocumentBody(true);rangeForPendingReference=null});
        safely(addMoreUrlsToAddPopupBtn,'click',()=>createUrlInputEntry('addRefUrlsContainer','',true));
        safely(addMoreUrlsToEditPopupBtn,'click',()=>createUrlInputEntry('editRefUrlsContainer','',true));
        safely(showHiddenBtn,'click',showHiddenChaptersPopup);
        safely(showBackupBtn,'click',showBackupPopup);
        safely(createBackupBtn,'click',handleCreateBackup);
        safely(confirmSplitBtn,'click',executeChapterSplit);
        safely(archiveDocBtn, 'click', handleArchiveDocument);
        document.querySelectorAll('.close-popup-btn').forEach(btn=>safely(btn,'click',()=>hidePopup(btn.closest('.popup'))));
        safely(referencesListUl,'click',e=>{if(e.target.classList.contains('ref-title')){const id=e.target.dataset.refId;if(!id)return;const span=editorsContainer.querySelector(`.text-editor-chapter span.referenced-text[data-ref-id="${id}"]`);const item=referencesListUl.querySelector(`li.reference-item[data-ref-id="${id}"]`);document.querySelectorAll('.highlight-scroll').forEach(el=>el.classList.remove('highlight-scroll'));if(span){span.scrollIntoView({behavior:'smooth',block:'center'});span.classList.add('highlight-scroll');if(item)item.classList.add('highlight-scroll');setTimeout(()=>document.querySelectorAll('.highlight-scroll').forEach(el=>el.classList.remove('highlight-scroll')),2500)}else{alert("Marcação não encontrada.")}}if(e.target.classList.contains('edit-ref-btn'))openEditReferencePopup(e.target.dataset.refId)});
        document.addEventListener('keydown',e=>{if(editorInterfaceDiv.style.display==='none'||document.querySelector('.popup.active'))return;if((e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==='z'){e.preventDefault();handleUndo()}if((e.ctrlKey||e.metaKey)&&e.key.toLowerCase()==='y'){e.preventDefault();handleRedo()}});
        document.addEventListener('selectionchange',()=>{const sel=window.getSelection();if(!activeEditorElement||!sel||!sel.rangeCount){hideFloatingToolbar();hideReferenceEyeToolbar();return}currentSelectionRange=sel.getRangeAt(0);if(activeEditorElement.contains(currentSelectionRange.commonAncestorContainer)){if(sel.isCollapsed){hideFloatingToolbar();const span=sel.anchorNode.parentElement?.closest('span.referenced-text[data-ref-id]');if(span){rangeForSplitting=currentSelectionRange.cloneRange();showReferenceEyeToolbar(span)}else{hideReferenceEyeToolbar()}}else if(sel.toString().trim()!==''){hideReferenceEyeToolbar();showFloatingToolbar()}else{hideFloatingToolbar();hideReferenceEyeToolbar()}}});
    });
    </script>
</body>
</html>
